{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Checkout</h2>

    {% if cart|length == 0 %}
        <p>Your cart is empty.</p>
    {% else %}
        <h4 class="mb-3">Order Summary</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Unit Price</th>
                    <th>Quantity</th>
                    <th>Total Price</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart %}
                    <tr>
                        <td>{{ item.product.name }}</td>
                        <td>â‚¹{{ item.price }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>â‚¹{{ item.total_price }}</td>
                    </tr>
                {% endfor %}
                <tr>
                    <td colspan="3" class="text-end"><strong>Total</strong></td>
                    <td><strong>â‚¹{{ cart.get_total_price }}</strong></td>
                </tr>
            </tbody>
        </table>

        <h4 class="mt-5 mb-3">Shipping Information</h4>
        <form id="razorpay-form" action="{% url 'orders:razorpay_payment' %}" method="post">
            {% csrf_token %}
            <div class="mb-3">
                {{ form.name.label_tag }}  
                {{ form.name }}
            </div>

            <!-- ðŸ”¸ Added Email Field -->
            <div class="mb-3">
                {{ form.email.label_tag }}  
                {{ form.email }}
            </div>

            <div class="mb-3">
                {{ form.address.label_tag }}
                {{ form.address }}
            </div>
            <div class="mb-3">
                {{ form.phone.label_tag }}
                {{ form.phone }}
            </div>
            <button type="button" id="pay-button" class="btn btn-warning mt-3">Pay with Razorpay</button>
        </form>

        <!-- Razorpay Script -->
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
        <script>
            document.getElementById('pay-button').onclick = function (e) {
                e.preventDefault();

                fetch("{% url 'orders:create_razorpay_order' %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    const options = {
                        "key": "{{ razorpay_key_id }}",
                        "amount": data.amount,
                        "currency": "INR",
                        "name": "Photon Cure",
                        "description": "Order Payment",
                        "order_id": data.razorpay_order_id,
                        "handler": function (response) {
                            const form = document.getElementById('razorpay-form');

                            const name = document.querySelector('[name="name"]').value;
                            const phone = document.querySelector('[name="phone"]').value;
                            const address = document.querySelector('[name="address"]').value;

                            // ðŸ”¸ New line to capture email
                            const email = document.querySelector('[name="email"]').value;

                            form.innerHTML += `<input type="hidden" name="razorpay_payment_id" value="${response.razorpay_payment_id}">`;
                            form.innerHTML += `<input type="hidden" name="razorpay_order_id" value="${response.razorpay_order_id}">`;
                            form.innerHTML += `<input type="hidden" name="razorpay_signature" value="${response.razorpay_signature}">`;
                            form.innerHTML += `<input type="hidden" name="name" value="${name}">`;
                            form.innerHTML += `<input type="hidden" name="email" value="${email}">`; <!-- ðŸ”¸ Added -->
                            form.innerHTML += `<input type="hidden" name="phone" value="${phone}">`;
                            form.innerHTML += `<input type="hidden" name="address" value="${address}">`;

                            form.submit();
                        },
                        "theme": {
                            "color": "#0b7285"
                        }
                    };
                    const rzp = new Razorpay(options);
                    rzp.open();
                });
            };
        </script>
    {% endif %}
</div>
{% endblock %}
